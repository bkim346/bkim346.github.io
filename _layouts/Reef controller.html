<!DOCTYPE html>
<html lang="{{ site.lang }}">

<!-- Head -->

<head>
  {%- if page.redirect -%}
  <meta http-equiv="refresh" content="3; url={{ site.baseurl }}/" />
  {%- endif -%}
  {% include head.html %}
  <title>Reef Live Data</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
</head>

<!-- Body -->

<body
  class="{% if site.navbar_fixed %}fixed-top-nav{% endif %} {% unless site.footer_fixed %}sticky-bottom-footer{% endunless %}">

  <!-- Header -->
  {%- include header.html %}

  <!-- Content -->
  <div class="container mt-5">
    <h1>Reef Live Data</h1>
    <div style="margin: 0 auto; background-color: white;">
      <canvas id="myChart"></canvas>
    </div>
  </div>

  <!-- Footer -->
  {%- include footer.html %}

  <script>
let myChart; // Variable to store the chart instance

function fetchDataAndRefreshChart() {
  // Retrieve the response data from the API endpoint
  fetch('https://reef-controller.duckdns.org/api/messages/pH')
    .then(response => response.text())
    .then(pHData => {
      // Fetch the current index data
      fetch('https://reef-controller.duckdns.org/api/messages/Current_ind')
        .then(response => response.json())
        .then(currentIndResponse => {
          currentIndResponse = parseInt(currentIndResponse);

          const pHResponse = pHData.trim();
          const pHResponseArray = pHResponse.split(',');

          console.log("test", currentIndResponse);
          // Create a line chart using Chart.js
          const ctx = document.getElementById('myChart').getContext('2d');

          // Check if the chart instance exists and destroy it
          if (myChart) {
            myChart.destroy();
          }

          myChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: Array.from({ length: 289 }, (_, i) => {
                const hour = Math.floor(i / 12);
                const minute = (i % 12) * 5;
                if (i === 288) {
                  return '24:00';
                } else {
                  return `${hour}:${minute.toString().padStart(2, '0')}`;
                }
              }),
              datasets: [{
                label: 'pH',
                data: pHResponseArray.map(Number),
                borderColor: 'rgba(120, 224, 143, 1)',
                fill: false,
                pointBackgroundColor: 'rgba(120, 224, 143, 1)'
              }, {
                label: 'Current Index',
                data: [{
                  x: currentIndResponse * 12, // Multiply by 12 to convert to the correct index on the x-axis
                  y: parseFloat(pHResponseArray[currentIndResponse])
                }],
                type: 'scatter',
                backgroundColor: 'rgba(255, 0, 0, 1)',
                pointRadius: 5
              }]
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  title: {
                    display: true,
                    text: 'Time (hours)'
                  },
                  ticks: {
                    maxRotation: 0,
                    autoSkip: true,
                    maxTicksLimit: 6
                  }
                },
                y: {
                  title: {
                    display: true,
                    text: 'pH'
                  },
                  min: 7.9,
                  max: 8.5
                }
              }
            }
          });
        });
    });
}



    // Fetch data and refresh chart initially
    fetchDataAndRefreshChart();

    // Refresh chart every minute
    setInterval(fetchDataAndRefreshChart, 300000);
  </script>
</body>

</html>