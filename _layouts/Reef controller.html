<!DOCTYPE html>
<html lang="{{ site.lang }}">

<!-- Head -->
<head>
  {%- if page.redirect -%}
  <meta http-equiv="refresh" content="3; url={{ site.baseurl }}/" />
  {%- endif -%}
  {% include head.html %}
  <title>Reef Live Data</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@{{ site.bootstrap.version }}/dist/js/bootstrap.bundle.min.js" integrity="{{ site.bootstrap.integrity.js }}" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@{{ site.mdb.version }}/js/mdb.min.js" integrity="{{ site.mdb.integrity.js }}" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4"></script>
</head>

<!-- Body -->
<body class="{% if site.navbar_fixed %}fixed-top-nav{% endif %} {% unless site.footer_fixed %}sticky-bottom-footer{% endunless %}">
  <!-- Header -->
  {%- include header.html %}
  <!-- Content -->
  <div class="container mt-5">
    <h1>Reef Live Data</h1>
    <div style="margin: 0 auto; background-color: white;">
      <canvas id="myChart"></canvas>
    </div>
  </div>
  <!-- Footer -->
  {%- include footer.html %}

  {% include scripts/misc.html %}
  <script>
    let myChart; // Variable to store the chart instance

    function fetchDataAndRefreshChart() {
      // Fetch the pH data from the API endpoint
      fetch('https://reef-controller.duckdns.org/api/messages/pH')
        .then(response => response.text())
        .then(pHData => {
          // Fetch the temperature data from the API endpoint
          fetch('https://reef-controller.duckdns.org/api/messages/Temp')
            .then(response => response.json())
            .then(data => {
              const matrixData = data.matrix;

              // Create the chart data
              const chartData = {
                labels: Array.from({ length: 288 }, (_, i) => {
                  const hour = Math.floor(i / 12);
                  const minute = (i % 12) * 5;
                  if (i === 288) {
                    return '24:00';
                  } else {
                    return `${hour}:${minute.toString().padStart(2, '0')}`;
                  }
                }),
                datasets: [
                  {
                    label: 'pH',
                    data: pHData.trim().split(',').map(parseFloat),
                    type: 'scatter',
                    backgroundColor: 'rgba(0, 100, 255, 1)', // Blue color for the plotted dot
                    pointRadius: 5
                  },
                  {
                    label: 'Temperature',
                    data: matrixData,
                    type: 'line',
                    backgroundColor: 'rgba(255, 0, 0, 1)', // Red color for the temperature line
                    borderColor: 'rgba(255, 0, 0, 1)', // Red color for the temperature line
                    fill: false,
                    pointRadius: 0, // Hide the data points for temperature
                    yAxisID: 'temperature-y-axis' // Assign the temperature dataset to the right y axis
                  }
                ]
              };

              // Create the chart options
              const chartOptions = {
                responsive: true,
                scales: {
                  xAxes: [
                    {
                      ticks: {
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 6 // Maximum number of x-axis ticks to display
                      }
                    }
                  ],
                  yAxes: [
                    {
                      id: 'pH-y-axis',
                      position: 'left',
                      ticks: {
                        beginAtZero: true,
                        suggestedMin: 7.8,
                        suggestedMax: 8.5
                      },
                      scaleLabel: {
                        display: true,
                        labelString: 'pH'
                      }
                    },
                    {
                      id: 'temperature-y-axis',
                      position: 'right',
                      ticks: {
                        suggestedMin: 74,
                        suggestedMax: 82
                      },
                      scaleLabel: {
                        display: true,
                        labelString: 'Temperature (Â°F)'
                      }
                    }
                  ]
                }
              };

              // Get the chart canvas element
              const ctx = document.getElementById('myChart').getContext('2d');

              // Destroy the previous chart instance if it exists
              if (myChart) {
                myChart.destroy();
              }

              // Create the new chart instance
              myChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: chartOptions
              });
            });
        });
    }

    // Fetch data and refresh chart initially
    fetchDataAndRefreshChart();

    // Refresh chart every minute
    setInterval(fetchDataAndRefreshChart, 60000);
  </script>

</body>

</html>
